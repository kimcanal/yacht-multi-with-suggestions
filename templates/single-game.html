<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² Yacht - Single Player</title>
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: #0f0f1e;
            color: #fff;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            overflow-x: hidden;
        }
        .background-fx {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(125deg, #0a0a1f, #141432, #1f1f45, #0f0f1e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        @media (max-width: 995px) { body { padding: 10px; } }
        .game-wrapper {
            max-width: 1400px; margin: 0 auto; display: flex; gap: 40px;
            flex-wrap: wrap; justify-content: center; align-items: flex-start;
        }
        .main-area { flex: 1 1 400px; max-width: 100%; }
        .title {
            font-size: 3em; font-weight: 700; margin-bottom: 30px;
            text-shadow: 0 0 30px rgba(0, 255, 200, 0.3); color: #00ffcc;
        }
        .dice-area {
            background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 40px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 30px;
        }
        .dice-grid {
            display: flex; flex-wrap: nowrap; gap: 8px; justify-content: space-between;
            margin-bottom: 20px; width: 100%;
        }
        .dice-item {
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            flex: 1; min-width: 0; font-size: min(3.1vw, 22px);
        }
        .keep-btn {
            padding: 6px 12px; font-size: 12px; font-weight: bold;
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px;
            background: rgba(255, 255, 255, 0.05); color: #fff; cursor: pointer;
            transition: all 0.2s ease; min-width: 0; width: 100%;
            text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .keep-btn:hover { border-color: rgba(0, 255, 200, 0.6); background: rgba(0, 255, 200, 0.1); }
        .keep-btn.active-keep { border-color: #00ff00; background: rgba(0, 255, 0, 0.2); color: #00ff00; font-weight: bold; }
        .die-container {
            width: 5em; height: 5em; position: relative; perspective: 1000px; transition: transform 0.3s ease;
        }
        .die-container.locked { transform: translateY(-15px); }
        .die {
            width: 100%; height: 100%; position: absolute; transform-style: preserve-3d;
            transition: transform 0.8s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .die-face {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(135deg, rgba(255,255,255,0.98), rgba(240,240,240,0.9));
            border: 2px solid rgba(200,200,200,0.5); border-radius: 0.8em;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            padding: 0.4em; backface-visibility: hidden; box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
        }
        .die-face .dot { margin: auto; box-shadow: inset 0 1px 3px rgba(0,0,0,0.5); }
        .face-1 { transform: rotateY(0deg) translateZ(2.5em); }
        .face-6 { transform: rotateY(180deg) translateZ(2.5em); }
        .face-2 { transform: rotateX(90deg) translateZ(2.5em); }
        .face-5 { transform: rotateX(-90deg) translateZ(2.5em); }
        .face-3 { transform: rotateY(90deg) translateZ(2.5em); }
        .face-4 { transform: rotateY(-90deg) translateZ(2.5em); }
        .die.rolling { animation: roll3d 1.5s linear infinite; }
        @keyframes roll3d {
            0% { transform: rotateX(0) rotateY(0) rotateZ(0); }
            100% { transform: rotateX(720deg) rotateY(360deg) rotateZ(360deg); }
        }
        .dot { width: 0.9em; height: 0.9em; background: #333; border-radius: 50%; transition: all 0.2s; }
        .dot.hidden { opacity: 0; }
        .controls {
            display: flex; gap: 15px; justify-content: center; margin-top: 10px; margin-bottom: 30px;
        }
        .btn {
            padding: 12px 30px; font-size: 16px; font-weight: 600; border: none; border-radius: 30px;
            cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4); transition: all 0.3s ease;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 25px rgba(102, 126, 234, 0.6); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-reset { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .info-bar {
            background: rgba(0, 255, 204, 0.1); border: 2px solid #00ffcc; border-radius: 15px; padding: 15px;
            text-align: center; font-size: 1.2em; color: #00ffcc; font-weight: bold;
        }
        .rolls-remaining { font-size: 1.5em; margin-bottom: 2px; line-height: 1.1; }
        .scorecard-area {
            background: rgba(255, 255, 255, 0.05); border-radius: 20px; padding: 30px;
            backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1);
            flex: 1 1 350px; max-width: 100%; margin: 0 auto;
        }
        @media (max-width: 995px) {
            .game-wrapper { gap: 24px; }
            .main-area { max-width: 480px; }
            .scorecard-area { max-width: 450px; }
            .dice-area { padding: 20px 12px; }
        }
        @media (max-width: 480px) {
            .game-wrapper { gap: 16px; }
            .dice-area { padding: 16px 10px; }
            .scorecard-area { padding: 20px 12px; }
        }
        .scorecard-title { font-size: 1.8em; font-weight: 700; margin-bottom: 25px; color: #00ffcc; text-align: center; }
        .score-item {
            display: flex; justify-content: space-between; align-items: center; padding: 14px 16px;
            margin: 8px 0; font-size: 1.05em; background: rgba(255, 255, 255, 0.05); border-radius: 10px;
            cursor: pointer; transition: all 0.3s ease; border-left: 4px solid transparent; position: relative;
        }
        .score-item:hover:not(.filled):not(.bonus) {
            background: rgba(102, 126, 234, 0.3); border-left-color: #667eea; transform: translateX(5px);
        }
        .score-item.filled { background: rgba(0, 255, 204, 0.15); cursor: default; border-left-color: #00ffcc; }
        .score-item.bonus { background: rgba(255, 215, 0, 0.15); border-left-color: #ffd700; font-weight: bold; cursor: default; }
        .score-name { font-weight: 500; font-size: 1.05em; flex: 1; }
        .score-val { font-weight: bold; color: #ffd700; font-size: 1.1em; min-width: 60px; text-align: right; }
        .score-preview { font-size: 0.85em; color: #00ffcc; margin-left: 10px; opacity: 0.8; }
        .total-score {
            margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255, 255, 255, 0.2);
            display: flex; justify-content: space-between; font-size: 1.3em; font-weight: bold; color: #ffd700;
        }
        .ai-breakdown {
            margin-top: 0; background: rgba(0, 0, 0, 0.3); border-radius: 10px; padding: 12px; font-size: 0.9em; text-align: left;
        }
        .breakdown-item {
            display: flex; justify-content: space-between; align-items: center; padding: 8px 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05); gap: 10px;
        }
        .breakdown-item:last-child { border-bottom: none; }
        .breakdown-val { color: #00ffcc; font-weight: bold; }
        .toast-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0.9);
            background: rgba(20, 20, 40, 0.95); color: #fff; padding: 30px 50px;
            border-radius: 20px; font-size: 2em; font-weight: 800; text-align: center;
            z-index: 2000; pointer-events: none; opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border: 2px solid #00ffcc; box-shadow: 0 0 50px rgba(0, 255, 204, 0.4);
            display: flex; flex-direction: column; gap: 10px;
        }
        .toast-overlay.show { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .toast-cat { font-size: 0.6em; color: #aaa; text-transform: uppercase; letter-spacing: 2px; }
        .toast-score { font-size: 1.5em; color: #ffd700; text-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        @media (max-width: 995px) { .toast-overlay { padding: 20px 30px; font-size: 1.3em; border-radius: 15px; max-width: 85%; } }
        /* ì¢ì€ í™”ë©´ ìµœì í™” */
        @media (max-width: 995px) {
            body { padding: 6px; }
            .game-wrapper { width: 100%; max-width: 100%; padding: 0; margin: 0; }
            .main-area { max-width: 100%; }
            .dice-area { width: 100%; max-width: 100%; margin: 0 auto; padding: 16px 2px; }
            .dice-grid { flex-wrap: wrap; justify-content: center; gap: 8px; width: 100%; max-width: none; margin: 0; padding: 0; }
            .dice-item { width: auto; flex: 0 0 30%; font-size: min(6vw, 22px); }
            .keep-btn { width: 100%; font-size: 11px; padding: 6px 0; }
        }
    </style>
</head>
<body>
    <div class="background-fx"></div>
    <div class="game-wrapper" style="max-width:1400px; margin:0 auto; display:flex; gap:60px; flex-wrap:wrap; justify-content:center; align-items:flex-start;">
        <div class="main-area" style="flex:1 1 480px; max-width:100%;">
            <div class="title" style="font-size:3.5em; font-weight:800; text-align:center; margin-bottom:40px; text-shadow:0 0 40px rgba(0,255,200,0.4); color:#00ffcc; letter-spacing:-1px;">ğŸ² YACHT</div>
            <div class="dice-area" style="background:rgba(255,255,255,0.07); border-radius:28px; padding:48px 36px; box-shadow:0 8px 40px rgba(0,255,204,0.08); border:1.5px solid rgba(255,255,255,0.12); margin-bottom:36px;">
                <div class="dice-grid" id="dice-grid"></div>
                <div class="info-bar" style="background:rgba(0,255,204,0.12); border:2px solid #00ffcc; border-radius:18px; padding:18px; text-align:center; font-size:1.25em; color:#00ffcc; font-weight:700; margin-top:18px;">
                    <div class="rolls-remaining" style="font-size:1.5em; margin-bottom:2px; line-height:1.1;">ë‚¨ì€ Roll: <span id="rolls-left">3</span>/3</div>
                    <div id="timer-bar" style="font-size:1.1em; color:#ff6b6b; margin:2px 0 0 0; font-weight:bold; display:none; line-height:2;">â³<span id="timer-count">30</span>ì´ˆ ë‚¨ì•˜ìŠµë‹ˆë‹¤</div>
                    <div id="game-status" style="color:#00ffcc; font-size:0.95em; text-align:center; min-height:24px;"></div>
                    <div id="ai-info-tip" style="margin-top:8px; padding:8px 12px; background:rgba(0,255,204,0.08); border-left:3px solid #00ffcc; border-radius:5px; font-size:0.85em; color:#aaa; line-height:1.4; display:none;">ğŸ’¡ AI ì¶”ì²œ: ê³ ë“ì  ì¡±ë³´(4 of a Kind, Full House, Straight, Yacht) ë‹¬ì„±ì„ ìš°ì„ ìœ¼ë¡œ ê³ ë ¤í•©ë‹ˆë‹¤.<br>ì´ë“¤ì„ ëª¨ë‘ ì™„ì„±í•œ í›„ì—ëŠ” ìƒë‹¨ ì¡±ë³´(Ones~Sixes)ë¥¼ íš¨ìœ¨ì ìœ¼ë¡œ ì±„ìš¸ ìˆ˜ ìˆëŠ” ì¡°í•©ì„ ì œì•ˆí•©ë‹ˆë‹¤.</div>
                    <div id="ai-breakdown" class="ai-breakdown"></div>
                </div>
            </div>
            <div class="controls" style="display:flex; gap:18px; justify-content:center; margin-top:10px; margin-bottom:36px;">
                <button class="btn" onclick="rollDice()" id="roll-btn" style="padding:14px 36px; font-size:1.15em; font-weight:700; border-radius:999px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; box-shadow:0 6px 25px rgba(102,126,234,0.5);">ğŸ² ROLL</button>
                <button class="btn btn-reset" onclick="resetGame()" id="new-game-btn" style="padding:14px 36px; font-size:1.15em; font-weight:700; border-radius:999px; background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); color:white; box-shadow:0 6px 25px rgba(245,87,108,0.5);">ğŸ”„ RESET</button>
                <button class="btn" style="padding:14px 36px; font-size:1.15em; font-weight:700; border-radius:999px; background:linear-gradient(135deg,#ff6b6b 0%,#c92a2a 100%); color:white; box-shadow:0 6px 25px rgba(255,107,107,0.4);" onclick="leaveRoom()">ğŸšª ë‚˜ê°€ê¸°</button>
            </div>
        </div>
        <div class="scorecard-area" style="background:rgba(255,255,255,0.07); border-radius:28px; padding:38px 30px; box-shadow:0 8px 40px rgba(0,255,204,0.08); border:1.5px solid rgba(255,255,255,0.12); flex:1 1 350px; max-width:100%; margin:0 auto;">
            <div id="scorecard"></div>
            <div id="score-desc-area" class="ai-breakdown" style="margin-top:18px;"></div>
            <div class="footer-credit" style="text-align:center; margin-top:38px; font-size:0.98em; color:rgba(180,220,255,0.6);">
                Made by <a href="https://kimcanal.github.io/" target="_blank" style="color:#00e6c3; font-weight:600; text-decoration:underline dotted;">kimcanal</a>
            </div>
        </div>
    </div>
    <div id="score-toast" class="toast-overlay"></div>
            <!-- ì‹±ê¸€ ë­í‚¹ ì €ì¥ ëª¨ë‹¬ -->
            <div id="save-modal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.45); z-index:3000; align-items:center; justify-content:center;">
                <div style="background:#181824; border-radius:18px; padding:38px 32px; box-shadow:0 8px 40px rgba(0,255,204,0.13); border:2px solid #00ffcc; min-width:320px; max-width:90vw; text-align:center;" onclick="event.stopPropagation();">
                        <!-- ë°”ê¹¥ í´ë¦­ ì‹œ ë‹«ê¸° -->
                        <script>document.getElementById('save-modal').onclick = function(e) { if(e.target === this) closeSaveModal(); };</script>
                    <div style="font-size:1.3em; font-weight:700; color:#00ffcc; margin-bottom:18px;">ğŸ† ë­í‚¹ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</div>
                    <input id="modal-username" type="text" maxlength="12" placeholder="ë‹‰ë„¤ì„ (2~12ì)" style="padding:12px 18px; border-radius:8px; border:1.5px solid #00ffcc; font-size:1.1em; margin-bottom:18px; width:80%; max-width:220px;">
                    <div style="margin-bottom:18px; color:#aaa; font-size:0.95em;">ìµœì¢… ì ìˆ˜: <span id="modal-score" style="color:#ffd700; font-weight:700;"></span></div>
                    <button onclick="saveSingleLeaderboard()" style="padding:12px 32px; font-size:1.1em; font-weight:700; border-radius:999px; background:linear-gradient(135deg,#00ffcc 0%,#00b894 100%); color:#181824; border:none; margin-right:10px;">ì €ì¥</button>
                    <button onclick="closeSaveModal()" style="padding:12px 32px; font-size:1.1em; font-weight:700; border-radius:999px; background:linear-gradient(135deg,#f093fb 0%,#f5576c 100%); color:white; border:none;">ì·¨ì†Œ</button>
                    <div id="modal-error" style="color:#ff6b6b; margin-top:12px; font-size:0.95em;"></div>
                </div>
            </div>
    <script src="/static/js/yacht_game.js"></script>
    <script>
        // íƒ€ì´ë¨¸ ê´€ë ¨ ë³€ìˆ˜
        let timerInterval = null;
        let timerLeft = 30;

        function startTurnTimer() {
            clearTurnTimer();
            if (rollsLeft !== 0 && rollsLeft !== 3 && !gameOver && !isRolling) {
                timerLeft = 30;
                document.getElementById('timer-bar').style.display = 'block';
                document.getElementById('timer-count').innerText = timerLeft;
                timerInterval = setInterval(() => {
                    timerLeft--;
                    document.getElementById('timer-count').innerText = timerLeft;
                    if (timerLeft <= 0) {
                        clearTurnTimer();
                        if (rollsLeft > 0 && !gameOver && !isRolling) {
                            rollDice();
                            timeOut();
                        }
                    }
                }, 1000);
            } else {
                document.getElementById('timer-bar').style.display = 'none';
            }
        }

        function clearTurnTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            document.getElementById('timer-bar').style.display = 'none';
        }

        // ì‹±ê¸€ í”Œë ˆì´ ëª¨ë“œ ì„¤ì •
        const username = localStorage.getItem('yacht_username') || 'Player';
        localStorage.removeItem('yacht_room'); // ë°© ì •ë³´ ì œê±°
        let isRolling = false;
        let gameOverToastShown = false;
        let connectionLostHandled = false;
        let syncFailures = 0;

        // í¸ì˜ì„± ë³€ìˆ˜ (ì½ê¸° ì „ìš©)
        let dice, kept, rollsLeft, myCard, oppCard, gameOver, aiRec;
        function updateLocalVars() {
            const state = GameState.getState();
            dice = state.dice;
            kept = state.kept;
            rollsLeft = state.rollsLeft;
            myCard = state.myCard;
            oppCard = state.oppCard;
            gameOver = state.gameOver;
            aiRec = state.aiRec;
        }
        updateLocalVars();

        function handleConnectionLost(msg = 'ìƒëŒ€ë°©ê³¼ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ì´ë™í•©ë‹ˆë‹¤.') {
            if (connectionLostHandled) return;
            connectionLostHandled = true;
            localStorage.removeItem('yacht_room');
            alert(msg);
            window.location.replace('/');
        }

        window.addEventListener('offline', () => {
            handleConnectionLost('ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ë¡œë¹„ë¡œ ì´ë™í•©ë‹ˆë‹¤.');
        });


        // ì‹±ê¸€ ë­í‚¹ ì €ì¥ ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ (ì „ì—­)
        function showSaveModal(score) {
            const name = localStorage.getItem('yacht_username') || '';
            if (!name || name.length < 2) {
                alert('ë‹‰ë„¤ì„ì´ 2ì ì´ìƒì´ì–´ì•¼ ë­í‚¹ì— ìë™ ë“±ë¡ë©ë‹ˆë‹¤.\në¡œë¹„ì—ì„œ ë‹‰ë„¤ì„ì„ ë¨¼ì € ì…ë ¥í•´ ì£¼ì„¸ìš”.');
                window.location.href = '/';
                return;
            }
            // í† ìŠ¤íŠ¸ê°€ ë¨¼ì € ë³´ì´ë„ë¡ 2ì´ˆ í›„ ë­í‚¹ ì €ì¥
            setTimeout(() => {
                fetch('/api/leaderboard/single', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: name, score: parseInt(score)})
                })
                .then(r => r.json())
                .then(data => {
                    const toast = document.getElementById('score-toast');
                    let rankingMsg = '';
                    if (!username || username === 'Player' || username.length < 2) {
                        rankingMsg = '<div class="toast-cat" style="color:#ff6b6b; margin-top:10px;">ë‹‰ë„¤ì„ì´ 2ì ì´ìƒì´ì–´ì•¼ ë­í‚¹ ë“±ë¡ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>';
                        // ê¸°ì¡´ í† ìŠ¤íŠ¸ì—ë§Œ ë©”ì‹œì§€ ì¶”ê°€, showGameOverToastì—ì„œ í† ìŠ¤íŠ¸ê°€ ì´ë¯¸ ëœ¨ë¯€ë¡œ showë§Œ ë³´ì¥
                        toast.classList.add('show');
                        toast.innerHTML += rankingMsg;
                        setTimeout(() => toast.classList.remove('show'), 3200);
                        return;
                    }
                    fetch('/api/leaderboard/single', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({username: username, score: parseInt(score)})
                    })
                    .then(r => r.json())
                    .then(data => {
                        if (data.success) {
                            rankingMsg = '<div class="toast-cat" style="color:#00ffcc; margin-top:10px;">ë­í‚¹ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!</div>';
                        } else {
                            rankingMsg = `<div class="toast-cat" style="color:#ff6b6b; margin-top:10px;">ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨: ${data.error || 'ì €ì¥ ì‹¤íŒ¨'}</div>`;
                        }
                        toast.classList.add('show');
                        toast.innerHTML += rankingMsg;
                        setTimeout(() => toast.classList.remove('show'), 3200);
                    })
                    .catch(e => {
                        rankingMsg = '<div class="toast-cat" style="color:#ff6b6b; margin-top:10px;">ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨: ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>';
                        toast.classList.add('show');
                        toast.innerHTML += rankingMsg;
                        setTimeout(() => toast.classList.remove('show'), 3200);
                    });
                })
                .catch(e => {
                    const toast = document.getElementById('score-toast');
                    toast.innerHTML = `<div class="toast-cat" style="color:#ff6b6b">ë­í‚¹ ë“±ë¡ ì‹¤íŒ¨</div><div class="toast-score" style="font-size:1.1rem">ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</div>`;
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3200);
                });
            }, 2000);
        }
        function closeSaveModal() {}
        function saveSingleLeaderboard() {}

        function showGameOverToast(myTotal, oppTotal) {
            if (gameOverToastShown) return;
            const toast = document.getElementById('score-toast');
            toast.innerHTML = `<div class="toast-cat">ğŸ‰ ê²Œì„ ì¢…ë£Œ</div><div class="toast-score">ìµœì¢… ì ìˆ˜: ${myTotal}</div>`;
            toast.classList.add('show');
            playTurnToastSound();
            gameOverToastShown = true;
            showSaveModal(myTotal);
            setTimeout(() => { toast.classList.remove('show'); }, 1800);
        }

        const isMyTurn = () => true; // ì‹±ê¸€ ëª¨ë“œëŠ” í•­ìƒ ë‚´ í„´

        function refreshTurnUI() {
            updateDice();
        }

        function updateDice() {
            const transforms = {
                1: 'rotateX(0deg) rotateY(0deg)',
                6: 'rotateX(180deg) rotateY(0deg)',
                2: 'rotateX(-90deg) rotateY(0deg)',
                5: 'rotateX(90deg) rotateY(0deg)',
                3: 'rotateY(-90deg) rotateX(0deg)',
                4: 'rotateY(90deg) rotateX(0deg)'
            };
            
            for (let i = 0; i < 5; i++) {
                const d = document.getElementById(`die-${i}`);
                const c = document.getElementById(`die-container-${i}`);
                if (!d) continue;
                
                if (rollsLeft === 3 && !gameOver) {
                    d.classList.add('rolling');
                } else {
                    d.classList.remove('rolling');
                }

                if (GameState.getKept()[i]) {
                    c.classList.add('locked');
                    d.querySelectorAll('.die-face').forEach(f => f.style.borderColor = '#00ffcc');
                } else {
                    c.classList.remove('locked');
                    d.querySelectorAll('.die-face').forEach(f => f.style.borderColor = 'rgba(200,200,200,0.5)');
                }
                
                const val = GameState.getDice()[i] || 1; 
                d.style.transform = transforms[val];
                
                const keepBtn = document.getElementById(`keep-${i}`);
                const keepText = document.getElementById(`keep-text-${i}`);
                if (keepBtn && keepText) {
                    keepBtn.className = 'keep-btn';
                    
                    if (rollsLeft === 3 || rollsLeft === 0 || gameOver || isRolling || !isMyTurn()) {
                        keepBtn.disabled = true;
                        keepBtn.style.opacity = '0.5';
                        keepBtn.style.cursor = 'not-allowed';
                    } else {
                        keepBtn.disabled = false;
                        keepBtn.style.opacity = '1';
                        keepBtn.style.cursor = 'pointer';
                    }
                    
                    if (kept[i]) {
                        keepBtn.classList.add('active-keep'); 
                        keepBtn.style.borderColor = '#00ff00';
                    } else {
                        keepBtn.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    }

                    let aiInfo = '';
                    keepBtn.style.boxShadow = 'none'; 

                    if (aiRec?.dice_recommendations) {
                        const r = aiRec.dice_recommendations[i];
                        if (r) {
                            if (r.action === 'keep' && !kept[i]) {
                                keepBtn.style.borderColor = '#00ffcc';
                                keepBtn.style.boxShadow = '0 0 10px rgba(0, 255, 204, 0.8)';
                            }
                        }
                    }
                    keepText.innerHTML = (kept[i] ? 'âœ“ KEEP' : 'KEEP') + aiInfo;
                }
                const lbl = document.getElementById(`lock-${i}`);
                if (lbl) lbl.innerText = '';
            }
            document.getElementById('rolls-left').innerText = GameState.getRollsLeft();            
            document.getElementById('roll-btn').disabled = GameState.getRollsLeft() <= 0 || GameState.isGameOver() || isRolling || !isMyTurn();
            
            // íƒ€ì´ë¨¸ í‘œì‹œ/ìˆ¨ê¹€ ì²˜ë¦¬
            if (rollsLeft !== 0 && rollsLeft !== 3  && !gameOver) {
                document.getElementById('timer-bar').style.display = 'block';
            } else {
                document.getElementById('timer-bar').style.display = 'none';
            }
        }

        function toggleLock(i) {
            // íƒ€ì´ë¨¸ê°€ ë™ì‘ ì¤‘ì¼ ë•Œë§Œ ë°˜ì‘ (rollsLeft > 0, gameOver=false, isRolling=false)
            if (rollsLeft === 3 || gameOver || !isMyTurn() || isRolling || !timerInterval) return;
            kept[i] = kept[i] ? 0 : 1;
            GameState.setKept(kept);
            updateDice();
            pushState();
            playKeepSound();
        }

        // ì‹±ê¸€ ëª¨ë“œì—ì„œëŠ” ì„œë²„ ë™ê¸°í™” ë¶ˆí•„ìš” (ë¹ˆ í•¨ìˆ˜ ì²˜ë¦¬)
        async function pushState() {}
        function applyRemoteState(state) {}
        async function fetchRoomState() {}
        function startSyncPolling() {}

        async function rollDice() {
            if (rollsLeft <= 0 || gameOver || isRolling) return;
            clearTurnTimer(); // roll ì‹œ íƒ€ì´ë¨¸ ì •ì§€

            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const duration = 0.4;
                const bufferSize = audioContext.sampleRate * duration;
                const noiseBuffer = audioContext.createBuffer(1, bufferSize, audioContext.sampleRate);
                const output = noiseBuffer.getChannelData(0);
                for (let i = 0; i < bufferSize; i++) output[i] = Math.random() * 2 - 1;
                
                const noiseSource = audioContext.createBufferSource();
                noiseSource.buffer = noiseBuffer;
                const noiseGain = audioContext.createGain();
                noiseSource.connect(noiseGain);
                noiseGain.connect(audioContext.destination);
                noiseGain.gain.setValueAtTime(0.2, now);
                noiseGain.gain.exponentialRampToValueAtTime(0.01, now + duration);
                
                const beatDuration = 0.08;
                for (let beat = 0; beat < 5; beat++) {
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.type = 'square';
                    const freqRange = 1200 - (beat * 160);
                    osc.frequency.value = Math.max(freqRange, 400);
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    const startTime = now + (beat * 0.07);
                    gain.gain.setValueAtTime(0.12, startTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, startTime + beatDuration);
                    osc.start(startTime);
                    osc.stop(startTime + beatDuration);
                }
                noiseSource.start(now);
                noiseSource.stop(now + duration);
            } catch (e) { console.warn('Audio context failed:', e); }

            isRolling = true;
            aiRec = null; 
            document.getElementById('ai-breakdown').innerHTML = '<div style="color:#999; text-align:center; padding:12px; font-size:0.9em;">ğŸ² ê³„ì‚° ì¤‘...</div>';
            updateDice(); 

            for (let i = 0; i < 5; i++) {
                if (!kept[i]) document.getElementById(`die-${i}`).classList.add('rolling');
            }
            
            setTimeout(async () => {
                try {
                    if (rollsLeft <= 0) {
                        alert('ë‚¨ì€ êµ´ë¦¼ì´ ì—†ìŠµë‹ˆë‹¤');
                        isRolling = false;
                        return;
                    }
                    for (let i = 0; i < 5; i++) {
                        if (!kept[i]) dice[i] = Math.floor(Math.random() * 6) + 1;
                    }
                    rollsLeft--;
                    GameState.setDice(dice);
                    GameState.setKept(kept);
                    GameState.setRollsLeft(rollsLeft);
                    
                    isRolling = false;
                    updateDice();
                    updateScorecard();
                    
                    if (calcScore(dice, 11) === 50) {
                        const toast = document.getElementById('score-toast');
                        if (myCard[11] >= 50) {
                            toast.innerHTML = `<div class="toast-cat">ğŸ† YACHT BONUS ê°€ëŠ¥!</div><div class="toast-score" style="font-size:0.9em;">ë‹¤ë¥¸ ì¹¸ì— ì ìˆ˜ ê¸°ë¡ ì‹œ +100ì </div>`;
                        } else if (myCard[11] === 0) {
                            toast.innerHTML = `<div class="toast-cat" style="color:#ff6b6b;">ğŸ˜¢ YACHT ì„±ê³µì´ì§€ë§Œ</div><div class="toast-score" style="color:#ff6b6b; font-size:0.85em;">Bonus ë¶ˆê°€ëŠ¥ (0ì  ì²˜ë¦¬ë¨)</div>`;
                        } else {
                            toast.innerHTML = `<div class="toast-cat">ğŸ² YACHT ì„±ê³µ!</div><div class="toast-score">50ì </div>`;
                        }
                        toast.classList.add('show');
                        playTurnToastSound();
                        setTimeout(() => toast.classList.remove('show'), 2000);
                    }
                    
                    await askAI();
                    startTurnTimer(); // roll í›„ íƒ€ì´ë¨¸ ì¬ì‹œì‘
                } catch (e) {
                    console.error('Roll failed:', e);
                    isRolling = false;
                }
            }, 600);
        }

        async function askAI() {
            if (gameOver || rollsLeft === 3) return;
            try {
                const open_categories = myCard.map((v, i) => v === null ? i : null).filter(v => v !== null);
                const r = await fetch('/api/recommend', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({dice, rolls_left: rollsLeft, scorecard: myCard, open_categories})
                });
                aiRec = await r.json();
                
                const bd = document.getElementById('ai-breakdown');
                if (aiRec.breakdown && aiRec.breakdown.length > 0) {
                    bd.innerHTML = aiRec.breakdown.map(item => {
                        let color = '#ffd700';
                        const barWidth = Math.min(item.prob * 100, 100);
                        return `
                            <div class="breakdown-item">
                                <div style="flex: 1;">
                                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                        <span style="font-size:1.3em; font-weight:bold; color:${color}">â¤</span>
                                        <span style="color:#ccc; font-weight:500">${item.name}</span>
                                    </div>
                                    <div style="font-size:0.9em; color:#aaa; margin-top:3px; margin-bottom:6px;">${item.keep_str}</div>
                                    <div style="background:rgba(0,0,0,0.3); border-radius:6px; height:6px; margin-right:8px;">
                                        <div style="background:${color}; border-radius:6px; height:100%; width:${barWidth}%; transition:width 0.3s ease;"></div>
                                    </div>
                                </div>
                                <span class="breakdown-val" style="color:${color}; font-weight:bold; min-width:50px; text-align:right">${item.val_str}</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    bd.innerHTML = '<div style="color:#999; text-align:center; padding:12px; font-size:0.9em;">ëŒ€ê¸° ì¤‘...</div>';
                }
                updateDice();
            } catch (e) { console.error(e); }
        }
        
        function timeOut(){
            const toast = document.getElementById('score-toast');
            toast.innerHTML = `<div class="toast-cat">â° ì‹œê°„ ì´ˆê³¼!</div><div class="toast-score">ìë™ Rollì´ ì‹¤í–‰ë©ë‹ˆë‹¤...</div>`;
            toast.classList.add('show');
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = 1000;
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } catch (e) { console.warn('Toast audio failed:', e); }
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function updateScorecard() {
            const el = document.getElementById('scorecard');
            if (!el) return;
            el.innerHTML = renderCard(myCard, true, 'ì ìˆ˜í‘œ');
            // ì ìˆ˜ ì„¤ëª… ì˜ì—­ ì´ˆê¸°í™”
            const descArea = document.getElementById('score-desc-area');
            if (descArea) descArea.innerHTML = '<div style="color:#999; text-align:center; padding:8px; font-size:0.95em;">ì ìˆ˜ í•­ëª©ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì„¤ëª…ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>';
        }

        function showToast(category, score) {
            const toast = document.getElementById('score-toast');
            toast.innerHTML = `<div class="toast-cat">${category}</div><div class="toast-score">+${score}</div>`;
            toast.classList.add('show');
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const now = audioContext.currentTime;
                const osc = audioContext.createOscillator();
                const gain = audioContext.createGain();
                osc.connect(gain);
                gain.connect(audioContext.destination);
                osc.frequency.value = 1000;
                gain.gain.setValueAtTime(0.3, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
                osc.start(now);
                osc.stop(now + 0.15);
            } catch (e) { console.warn('Toast audio failed:', e); }
            setTimeout(() => toast.classList.remove('show'), 1500);
        }

        function pickCategory(i) {
            if (rollsLeft === 3 || gameOver) return;
            clearTurnTimer(); 

            const aiBreakdown = document.getElementById('ai-breakdown');
            if (aiBreakdown) aiBreakdown.innerHTML = '';

            let score = calcScore(dice, i);

            if (calcScore(dice, 11) === 50 && myCard[11] >= 50 && i !== 11 && score > 0) {
                myCard[11] += 100;
                myCard[i] = score;
                showToast(`ğŸ† Yacht Bonus: ${CATS[i]} +${score}ì , Yacht +100ì `, score);
                dice = [1,1,1,1,1];
                kept = [0,0,0,0,0];
                rollsLeft = 3;
                aiRec = null;
                GameState.setState({dice, kept, rollsLeft, myCard: [...myCard], oppCard: [...oppCard], gameOver, aiRec});
                updateDice();
                updateScorecard();
                return;
            }

            myCard[i] = score;
            showToast(CATS[i], score);

            dice = [1,1,1,1,1];
            kept = [0,0,0,0,0];
            rollsLeft = 3;
            aiRec = null;
            startTurnTimer(); 

            const myDone = myCard.every(v => v !== null);
            if (myDone) {
                gameOver = true;
                const myTotal = calcTotals(myCard).total;
                const statusEl = document.getElementById('game-status');
                if (statusEl) statusEl.innerText = `ğŸ‰ ê²Œì„ ì¢…ë£Œ! ìµœì¢… ì ìˆ˜: ${myTotal}`;
                showGameOverToast(myTotal, 0);
                if (username) saveGameResult(username, myTotal, null, 0);
            }

            GameState.setState({
                dice: [...dice],
                kept: [...kept],
                rollsLeft,
                myCard: [...myCard],
                oppCard: [...oppCard],
                gameOver,
                aiRec,
            });

            updateDice();
            updateScorecard();
            refreshTurnUI();
        }

        function resetGame() {
            if (!confirm('ğŸ”„ ìƒˆ ê²Œì„ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\ní˜„ì¬ ê²Œì„ ì§„í–‰ ìƒí™©ì´ ëª¨ë‘ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.')) return;
            location.reload();
        }

        function saveGameResult(username, finalScore, player2 = null, score2 = 0) {
            fetch('/api/save-game', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    player1: username,
                    score1: finalScore,
                    player2,
                    score2
                })
            })
            .then(r => r.json())
            .then(data => {
                console.log('Game saved:', data);
            })
            .catch(e => console.error('Failed to save game:', e));
        }

        async function leaveRoom() {
            if (!confirm('ì •ë§ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            window.location.replace('/');
        }

        function passTurn() {}

        async function initializeGame() {
            renderDice();
            updateScorecard();
            document.getElementById('ai-breakdown').innerHTML = '<div style="color:#999; text-align:center; padding:12px; font-size:0.9em;">ğŸ² ì£¼ì‚¬ìœ„ë¥¼ êµ´ë ¤ì£¼ì„¸ìš”</div>';
            
            const roomLabel = document.getElementById('room-label');
            if (roomLabel) roomLabel.textContent = '';
            
            const multiControls = document.getElementById('multiplayer-controls');
            if (multiControls) multiControls.style.display = 'none';
            
            const newGameBtn = document.getElementById('new-game-btn');
            if (newGameBtn) newGameBtn.style.display = 'inline-block';
            
            refreshTurnUI();
            startTurnTimer();
        }

        initializeGame().catch(e => console.error('Initialization error:', e));
    </script>
</body>
</html>