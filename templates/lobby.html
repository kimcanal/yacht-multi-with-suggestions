<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ² Yacht - ë¡œë¹„</title>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼] */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #0f0f1e; color: #e0e0e0; font-family: 'Pretendard', sans-serif; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* ë°°ê²½: ë” ê¹Šì´ê° ìˆê²Œ */
        .background-fx { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; 
            background: radial-gradient(circle at 50% 50%, #1a1a3e 0%, #050510 100%);
            animation: pulseBg 10s infinite alternate;
        }
        @keyframes pulseBg {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .lobby-container { 
            width: 95%; max-width: 1500px; height: 92vh; 
            background: rgba(20, 20, 35, 0.7); /* ë°˜íˆ¬ëª…ë„ ì¡°ì ˆ */
            border-radius: 24px; padding: 35px; 
            backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 40px 80px rgba(0, 0, 0, 0.5); 
            display: flex; flex-direction: column;
            animation: fadeIn 0.8s ease-out;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* í—¤ë” */
        .header-area { flex: 0 0 auto; display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .title { font-family: 'Rajdhani', sans-serif; font-size: 3.2rem; font-weight: 800; color: #fff; margin: 0; text-shadow: 0 0 25px rgba(0,255,204,0.5); letter-spacing: 2px; }
        .control-bar { display: flex; gap: 15px; align-items: center; }

        /* íŒ¨ë„ ê³µí†µ */
        .main-content-grid { flex: 1; display: grid; grid-template-columns: 340px 1fr 340px; gap: 25px; overflow: hidden; }
        .col-wrapper { display: flex; flex-direction: column; gap: 25px; height: 100%; min-height: 0; }
        
        .panel { 
            background: rgba(0, 0, 0, 0.25); 
            border-radius: 18px; 
            border: 1px solid rgba(255, 255, 255, 0.05); 
            display: flex; flex-direction: column; overflow: hidden; 
            flex: 1; min-height: 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            transition: transform 0.2s, border-color 0.2s;
        }
        .panel:hover { border-color: rgba(255,255,255,0.15); }

        .panel-header { 
            padding: 18px 22px; background: rgba(255, 255, 255, 0.03); 
            border-bottom: 1px solid rgba(255, 255, 255, 0.08); 
            font-weight: 700; color: #00ffcc; font-size: 1.15em; 
            display: flex; justify-content: space-between; align-items: center;
            letter-spacing: 0.5px;
        }

        .panel-body { flex: 1; overflow-y: auto; padding: 15px; position: relative; }
        .panel-body::-webkit-scrollbar { width: 6px; }
        .panel-body::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 4px; }

        /* [NEW] ë¹ˆ ìƒíƒœ ê¾¸ë¯¸ê¸° */
        .empty-state {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            height: 100%; color: #666; text-align: center; gap: 15px;
        }
        .empty-icon { font-size: 3rem; opacity: 0.3; filter: grayscale(100%); margin-bottom: 5px; }
        .empty-text { font-size: 0.95em; color: #777; line-height: 1.4; }

        /* ë°© ëª©ë¡ ì•„ì´í…œ */
        .room-item { 
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(255,255,255,0.01) 100%);
            padding: 16px 20px; margin-bottom: 10px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            border: 1px solid rgba(255, 255, 255, 0.05); transition: all 0.2s; 
        }
        .room-item:hover { 
            background: linear-gradient(90deg, rgba(0, 255, 204, 0.1) 0%, rgba(0,0,0,0) 100%);
            border-color: rgba(0,255,204,0.3); transform: translateX(5px); 
        }
        .room-code { color: #fff; font-weight: 700; font-size: 1.2em; font-family:'Rajdhani'; }
        
        /* ìœ ì € ë°°ì§€ */
        .user-badge { 
            display: flex; align-items: center; gap: 10px; 
            background: rgba(0, 255, 204, 0.05); 
            border: 1px solid rgba(0, 255, 204, 0.2); 
            padding: 8px 18px; border-radius: 50px; margin-right: 15px; 
        }
        .user-name-display { font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(0, 255, 204, 0.4); }
        
        /* ë²„íŠ¼ë“¤ */
        .btn-mini { padding: 12px 24px; border-radius: 12px; border: none; font-weight: 700; color: white; cursor: pointer; transition: 0.2s; font-size: 0.95rem; }
        .btn-mini:hover { transform: translateY(-2px); filter: brightness(1.2); box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .btn-p { background: linear-gradient(135deg, #6366f1, #8b5cf6); }
        .btn-s { background: linear-gradient(135deg, #00b894, #00cec9); color:#00332c; }
        .btn-c { background: linear-gradient(135deg, #ec4899, #f43f5e); }
        .btn-logout { background: none; border: 1px solid #ff6b6b; color: #ff6b6b; padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; cursor: pointer; transition:0.2s; }
        .btn-logout:hover { background: rgba(255, 107, 107, 0.1); }

        .input-mini { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.15); color: #fff; padding: 12px 16px; border-radius: 12px; width: 150px; font-size: 1rem; text-align:center; letter-spacing:1px; }
        .input-mini:focus { border-color: #00ffcc; outline: none; }

        /* ê¸°íƒ€ ìš”ì†Œë“¤ */
        .leaderboard-item { display: flex; justify-content: space-between; padding: 12px 8px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.95em; }
        .rank-badge { color: #00ffcc; font-weight: bold; width: 24px; display: inline-block; font-family:'Rajdhani'; }
        
        .status-row { margin-bottom: 18px; }
        /* [ìˆ˜ì •] ë¼ë²¨ì„ ìƒë‹¨ ì •ë ¬ */
        .status-label { font-size: 0.85em; color: #ccc; display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 6px; }
        .bar-bg { width: 100%; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; }
        .bar-fill { height: 100%; background: #00ffcc; width: 0%; transition: width 0.5s; box-shadow: 0 0 10px rgba(0,255,204,0.5); }
        
        .rank-tabs { display: flex; gap: 8px; }
        .rank-tab { background: transparent; border: 1px solid rgba(255,255,255,0.2); color: #888; padding: 4px 10px; border-radius: 15px; cursor: pointer; font-size: 0.75em; transition: 0.2s; }
        .rank-tab.active { background: rgba(0,255,204,0.15); border-color: #00ffcc; color: #00ffcc; font-weight: bold; }

        .status-badge { font-size:0.7em; padding:2px 8px; border-radius:10px; margin-left:8px; font-weight:600; }
        .badge-wait { background:rgba(255,255,255,0.1); color:#aaa; }
        .badge-game { background:rgba(0, 184, 148, 0.2); color:#00ffcc; border:1px solid rgba(0, 255, 204, 0.3); }

        /* ë¡œê·¸ì¸ ì˜¤ë²„ë ˆì´ */
        #login-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(10, 10, 20, 0.85); backdrop-filter: blur(12px); z-index: 9999; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        .login-box { text-align: center; background: rgba(30, 30, 50, 0.6); padding: 60px; border-radius: 40px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5); }
        .login-title { font-family: 'Rajdhani', sans-serif; font-size: 5rem; font-weight: 800; color: #fff; margin-bottom: 40px; text-shadow: 0 0 40px rgba(0,255,204,0.6); }
        .login-input { width: 100%; padding: 20px 30px; font-size: 1.3rem; background: rgba(0,0,0,0.4); border: 2px solid rgba(255,255,255,0.15); color: #fff; border-radius: 15px; margin-bottom: 25px; text-align: center; transition: 0.3s; }
        .login-input:focus { border-color: #00ffcc; outline: none; box-shadow: 0 0 25px rgba(0, 255, 204, 0.2); }
        .login-btn { width: 100%; padding: 20px; font-size: 1.4rem; font-weight: 800; background: linear-gradient(135deg, #00b894, #00cec9); border: none; border-radius: 15px; color: #00332c; cursor: pointer; transition: 0.2s; box-shadow: 0 10px 30px rgba(0, 184, 148, 0.3); }
        .login-btn:hover { transform: scale(1.03); filter: brightness(1.1); }

        @media (max-width: 1200px) {
            .lobby-container { height: auto; max-height: 95vh; overflow-y: auto; }
            .main-content-grid { display: flex; flex-direction: column; overflow: visible; }
            .panel { height: 350px; flex: none; }
        }
    </style>
</head>
<body>
    <div class="background-fx"></div>

    <div id="login-overlay">
        <div class="login-box">
            <div class="login-title">ğŸ² YACHT</div>
            <div style="margin-bottom:15px; color:#aaa; font-size:1.1em;">ì˜¤ëŠ˜ì˜ ë‹‰ë„¤ì„ì€ ë¬´ì—‡ì¸ê°€ìš”?</div>
            <input type="text" id="login-username" class="login-input" placeholder="Player Name" maxlength="12" autofocus>
            <button class="login-btn" onclick="submitLogin()">GAME START</button>
        </div>
    </div>

    <div class="lobby-container">
        <div class="header-area">
            <div class="title">ğŸ² YACHT <span style="font-size:0.5em; color:#aaa; vertical-align:middle;">ONLINE</span></div>
            <div class="control-bar">
                <div class="user-badge">
                    <span style="font-size:0.9em; color:#aaa;">PLAYER</span>
                    <span id="display-username" class="user-name-display">Guest</span>
                    <button class="btn-logout" onclick="logout()">âœ•</button>
                </div>
                <div style="width:1px; height:30px; background:rgba(255,255,255,0.15); margin:0 5px;"></div>
                <button class="btn-mini btn-p" onclick="startGame('single')">ğŸ® í˜¼ìí•˜ê¸°</button>
                <div style="width:1px; height:30px; background:rgba(255,255,255,0.15); margin:0 5px;"></div>
                <input type="text" id="room-code" class="input-mini" placeholder="CODE" maxlength="10" style="text-transform:uppercase;">
                <button class="btn-mini btn-s" onclick="joinRoomById()">ì…ì¥</button>
                <button class="btn-mini btn-c" onclick="createRoom()">ë°© ìƒì„±</button>
            </div>
        </div>

        <div class="main-content-grid">

            <div class="col-wrapper">
                <div class="panel" style="flex: 1.5;">
                    <div class="panel-header">
                        <span>ğŸ‘¥ ì ‘ì†ì í˜„í™©</span>
                    </div>
                    <div class="panel-body" id="lobby-user-list">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ”­</div>
                            <div class="empty-text">ì ‘ì†ìë¥¼ ì°¾ëŠ” ì¤‘...</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="flex: 1;">
                    <div class="panel-header">ğŸ“Š ì„œë²„ ìƒíƒœ</div>
                    <div class="panel-body">
                        <div class="status-row">
                            <div class="status-label"><span>Active Users</span> <span id="online-count" style="color:#fff; font-weight:700;">-</span></div>
                        </div>
                        <div class="status-row">
                            <div class="status-label"><span>Active Games</span> <span id="active-rooms" style="color:#fff; font-weight:700;">-</span></div>
                        </div>
                        <div class="status-row">
                            <div class="status-label"><span>CPU Usage (Intel N100)</span> <span id="cpu-usage">-</span></div>
                            <div class="bar-bg"><div class="bar-fill" id="cpu-bar"></div></div>
                        </div>
                        <div class="status-row">
                            <div class="status-label">
                                <span>Memory</span> 
                                <div style="text-align:right;">
                                    <span id="memory-usage" style="display:block;">-</span>
                                    <span id="memory-actual" style="font-size:0.75em; color:#888; font-weight:400;"></span>
                                </div>
                            </div>
                            <div class="bar-bg"><div class="bar-fill" id="memory-bar"></div></div>
                        </div>
                        <div style="margin-top:15px; text-align:center; font-size:0.75em; color:#555; font-family:'Rajdhani'">ID: <span id="client-id-disp">...</span></div>
                    </div>
                </div>
            </div>

            <div class="col-wrapper">
                <div class="panel">
                    <div class="panel-header">
                        <span>ğŸ“œ ëŒ€ê¸°ì‹¤ ëª©ë¡</span>
                        <span style="font-size:0.8em; color:#aaa; font-weight:400;">Real-time</span>
                    </div>
                    <div class="panel-body" id="room-list">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ²</div>
                            <div class="empty-text">ìƒì„±ëœ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.<br>ìƒˆë¡œìš´ ë°©ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-wrapper">
                <div class="panel" style="flex: 2;">
                    <div class="panel-header">
                        <span>ğŸ† ëª…ì˜ˆì˜ ì „ë‹¹</span>
                        <div class="rank-tabs">
                            <button class="rank-tab active" onclick="switchRank('multi')" id="tab-multi">ë©€í‹°</button>
                            <button class="rank-tab" onclick="switchRank('single')" id="tab-single">ì‹±ê¸€</button>
                        </div>
                    </div>
                    <div class="panel-body" id="leaderboard-list">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ†</div>
                            <div class="empty-text">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ìŠ¹ë¦¬ì˜ ì£¼ì¸ê³µì´ ë˜ì„¸ìš”!</div>
                        </div>
                    </div>
                </div>

                <div class="panel" style="flex: 1;">
                    <div class="panel-header">ğŸ’¡ Game Tip</div>
                    <div class="panel-body" style="display:flex; align-items:center;">
                        <div style="font-size:0.9em; color:#ccc; line-height:1.6;">
                            <strong style="color:#00ffcc;">Yacht (50ì )</strong>ì€ ì£¼ì‚¬ìœ„ 5ê°œê°€ ëª¨ë‘ ê°™ì€ ìˆ«ìì¼ ë•Œ íšë“í•  ìˆ˜ ìˆëŠ” ìµœê³ ì˜ ì¡±ë³´ì…ë‹ˆë‹¤. AI ì¶”ì²œì„ í™œìš©í•´ë³´ì„¸ìš”!
                        </div>
                    </div>
                </div>
            </div>

        </div>
        <div id="error" style="color:#ff6b6b; text-align:center; margin-top:10px; font-weight:bold;"></div>
    </div>

    <footer style="position:fixed; bottom:15px; width:100%; text-align:center; pointer-events:auto;">
        <span style="background:rgba(0,0,0,0.6); padding:5px 15px; border-radius:20px; color:#555; font-size:0.8em;">Developed by <a href="https://kimcanal.github.io/" target="_blank" style="color:#00ffcc; text-decoration:none; font-weight:600;">kimcanal</a></span>
    </footer>

    <script>
        let clientId = localStorage.getItem('yacht_client_id');
        if (!clientId) {
            clientId = 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('yacht_client_id', clientId);
        }
        document.getElementById('client-id-disp').textContent = clientId.substr(-6);

        let myUsername = localStorage.getItem('yacht_username');
        let isLoggedIn = false;

        function checkLogin() {
            if (myUsername && myUsername.length >= 2) {
                document.getElementById('login-overlay').style.display = 'none';
                document.getElementById('display-username').textContent = myUsername;
                isLoggedIn = true;
                startPolling();
            } else {
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('login-username').focus();
            }
        }

        function submitLogin() {
            const name = document.getElementById('login-username').value.trim();
            if (!name || name.length < 2) {
                alert('ë‹‰ë„¤ì„ì„ 2ê¸€ì ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”!');
                return;
            }
            myUsername = name;
            localStorage.setItem('yacht_username', name);
            document.getElementById('display-username').textContent = name;
            
            const overlay = document.getElementById('login-overlay');
            overlay.style.opacity = '0';
            setTimeout(() => {
                overlay.style.display = 'none';
                isLoggedIn = true;
                sendHeartbeat(); 
                startPolling();  
            }, 300);
        }

        function logout() {
            if(confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                localStorage.removeItem('yacht_username');
                location.reload(); 
            }
        }

        document.getElementById('login-username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitLogin();
        });

        let currentRankMode = 'multi'; 

        function startGame() {
            localStorage.setItem('yacht_username', myUsername); 
            localStorage.removeItem('yacht_room');
            location.href = '/game/single';
        }

        async function createRoom() {
            if(!myUsername) return;
            try {
                const res = await fetch('/api/rooms', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:myUsername})});
                const data = await res.json();
                if(data.code) { localStorage.setItem('yacht_room', data.code); location.href=`/game/multi?room=${data.code}`; }
            } catch(e) { alert('ì˜¤ë¥˜'); }
        }

        async function joinRoomById() {
            const code = document.getElementById('room-code').value.trim().toUpperCase();
            if(!code) return alert('ë°© ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”');
            try {
                const res = await fetch(`/api/rooms/${code}/join`, {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username:myUsername})});
                const data = await res.json();
                if(res.ok) { localStorage.setItem('yacht_room', code); location.href=`/game/multi?room=${code}`; }
                else document.getElementById('error').innerText = data.error;
            } catch(e) {}
        }

        async function joinAsObserver(code) {
            const obsName = 'Guest_' + Math.floor(Math.random()*1000);
            try {
                const res = await fetch(`/api/rooms/${code}/observe`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username: obsName})
                });
                if(res.ok) {
                    localStorage.setItem('yacht_username', obsName); 
                    localStorage.setItem('yacht_room', code);
                    location.href = `/game/multi?room=${code}&mode=observer`;
                } else {
                    const d = await res.json();
                    alert(d.error || 'ì‹¤íŒ¨');
                }
            } catch(e) { alert('ì˜¤ë¥˜'); }
        }

        function loadLobbyUsers() {
            if (!isLoggedIn) return; 
            fetch('/api/online-users').then(r=>r.json()).then(users=>{
                const list = document.getElementById('lobby-user-list');
                if(!users.length) {
                    list.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ”­</div><div class="empty-text">ì ‘ì†ì ì—†ìŒ</div></div>';
                    return;
                }
                list.innerHTML = users.map(u => {
                    let name = (u.username && u.username !== 'undefined') ? u.username : 'ìµëª…';
                    const isMe = name === myUsername;
                    const nameColor = isMe ? '#ffd700' : '#00ffcc';
                    const meLabel = isMe ? '<span style="color:#aaa; font-size:0.8em; margin-left:4px;">(ë‚˜)</span>' : '';
                    
                    let statusBadge = '';
                    if(u.status === 'ê²Œì„ì¤‘') statusBadge = '<span class="status-badge badge-game">ê²Œì„ì¤‘</span>';
                    else statusBadge = '<span class="status-badge badge-wait">ëŒ€ê¸°ì¤‘</span>';

                    return `
                    <div style="padding:10px 0; color:${nameColor}; font-weight:600; font-size:1.05em; display:flex; align-items:center; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <span style="font-size:0.6em; margin-right:10px;">â—</span>
                        ${name} ${meLabel}
                        <div style="margin-left:auto;">${statusBadge}</div>
                    </div>`;
                }).join('');
            }).catch(()=>{});
        }

        function loadRoomList() {
            fetch('/api/rooms', {cache:'no-store'}).then(r=>r.json()).then(rooms=>{
                const list = document.getElementById('room-list');
                if(!rooms.length) { 
                    list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ²</div><div class="empty-text">ëŒ€ê¸° ì¤‘ì¸ ë°© ì—†ìŒ<br>ìƒˆë¡œìš´ ë°©ì„ ìƒì„±í•´ë³´ì„¸ìš”!</div></div>'; 
                    return; 
                }
                list.innerHTML = rooms.map(r=>{
                    const isFull = r.players.length >= 2;
                    let pInfo = r.players.length === 0 ? 'ëŒ€ê¸° ì¤‘' :
                                r.players.length === 1 ? `<span style="color:#00ffcc">${r.players[0]}</span>` :
                                `<span style="color:#00ffcc">${r.players[0]}</span> vs <span style="color:#ff6b6b">${r.players[1]}</span>`;
                    
                    return `
                    <div class="room-item">
                        <div>
                            <div class="room-code">ğŸ® ${r.code}</div>
                            <div style="font-size:0.9em; color:#aaa; margin-top:2px;">${pInfo}</div>
                        </div>
                        ${isFull 
                            ? `<button class="btn-mini" style="background:#e17055; padding:6px 12px; font-size:0.8em;" onclick="joinAsObserver('${r.code}')">ğŸ‘ï¸ ê´€ì „</button>`
                            : `<button class="btn-mini btn-s" style="padding:6px 12px; font-size:0.8em;" onclick="joinRoom('${r.code}')">ì°¸ê°€</button>`
                        }
                    </div>`;
                }).join('');
            }).catch(()=>{});
        }
        window.joinRoom = function(code) { document.getElementById('room-code').value=code; joinRoomById(); }

        function switchRank(mode) {
            currentRankMode = mode;
            document.getElementById('tab-multi').className = mode === 'multi' ? 'rank-tab active' : 'rank-tab';
            document.getElementById('tab-single').className = mode === 'single' ? 'rank-tab active' : 'rank-tab';
            loadLeaderboard();
        }

        function loadLeaderboard() {
            if (!isLoggedIn) return;
            const endpoint = currentRankMode === 'multi' ? '/api/leaderboard/multi' : '/api/leaderboard/single';
            fetch(endpoint).then(r=>r.json()).then(users=>{
                const list = document.getElementById('leaderboard-list');
                if(!users.length) { 
                    list.innerHTML='<div class="empty-state"><div class="empty-icon">ğŸ†</div><div class="empty-text">ê¸°ë¡ ì—†ìŒ<br>ì²« ìŠ¹ë¦¬ì˜ ì£¼ì¸ê³µì´ ë˜ì„¸ìš”!</div></div>'; 
                    return; 
                }
                
                list.innerHTML = users.slice(0,20).map((u, i) => {
                    let detail = '';
                    if(currentRankMode === 'multi') detail = `${u.wins}ìŠ¹ ${u.losses}íŒ¨`;
                    else detail = `${u.score}ì `; 
                    
                    return `
                    <div class="leaderboard-item">
                        <div style="font-weight:500; color:#eee;"><span class="rank-badge">${i+1}</span> ${u.username}</div>
                        <div style="color:#aaa; font-family:'Rajdhani'">${detail}</div>
                    </div>`;
                }).join('');
            }).catch(()=>{});
        }

        function loadSystemStatus() {
            fetch('/api/system-status').then(r=>r.json()).then(data=>{
                document.getElementById('online-count').textContent=data.online_count;
                document.getElementById('active-rooms').textContent=data.active_rooms;
                document.getElementById('cpu-bar').style.width=data.cpu_percent+'%';
                document.getElementById('memory-bar').style.width=data.memory_percent+'%';
                
                // ìˆ«ìë„ í•¨ê»˜ í‘œì‹œ
                document.getElementById('cpu-usage').textContent = data.cpu_percent + '%';
                document.getElementById('memory-usage').textContent = data.memory_percent + '%';
                
                // [NEW] ì‹¤ì œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰(GB)ë„ í‘œì‹œ
                if (data.memory_used_gb !== undefined && data.memory_total_gb !== undefined) {
                    document.getElementById('memory-actual').textContent = `(${data.memory_used_gb}GB / ${data.memory_total_gb}GB)`;
                } else {
                    document.getElementById('memory-actual').textContent = '';
                }
            }).catch(()=>{});
        }

        function sendHeartbeat() {
            if (!isLoggedIn) return;
            fetch('/api/lobby-heartbeat', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({client_id:clientId, username:myUsername})}).catch(()=>{});
        }

        document.getElementById('room-code').addEventListener('keypress', (e) => { if(e.key === 'Enter') joinRoomById(); });

        function startPolling() {
            loadLobbyUsers();
            loadRoomList();
            loadLeaderboard();
            loadSystemStatus();
            sendHeartbeat();
            
            setInterval(loadLobbyUsers, 3000);
            setInterval(loadRoomList, 3000);
            setInterval(loadSystemStatus, 3000);
            setInterval(sendHeartbeat, 10000);
        }

        checkLogin();

    </script>
</body>
</html>